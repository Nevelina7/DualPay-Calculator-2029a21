<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DualPay Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f7ff; /* Основен цвят на фона */
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        h1, h2, .logo-font { font-family: 'Comfortaa', cursive; }

        /* Динамичен фон */
        .bg-pattern {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            opacity: 0.1; /* Едва забележими символи */
            z-index: -1;
            pointer-events: none;
        }
        .bg-symbol {
            font-size: 2rem;
            animation: float 10s infinite linear;
        }
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg) scale(1); }
            50% { transform: translate(20px, 20px) rotate(10deg) scale(1.1); }
            100% { transform: translate(0, 0) rotate(0deg) scale(1); }
        }

        /* App-like прозорец */
        .app-window {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            margin: 1rem;
        }

        .btn-primary { background-color: #228b22; } /* Горско зелено */
        .error-box { border: 2px solid #ef4444; background-color: #fee2e2; }
    </style>
</head>
<body>

    <div class="bg-pattern" id="bgPattern"></div>

    <div class="app-window">
        <div class="flex flex-col items-center mb-6">
            <canvas id="appIcon" width="80" height="80" class="mb-2"></canvas>
            <h1 class="text-2xl font-bold text-gray-800">DualPay</h1>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-semibold mb-1">Дължима сума:</label>
                <div class="flex gap-2">
                    <input type="number" id="dueAmount" step="0.01" class="w-full p-3 rounded-xl border focus:ring-2 focus:ring-green-500 outline-none" placeholder="0.00">
                    <select id="dueCurrency" class="p-3 rounded-xl border bg-white">
                        <option value="BGN">лв</option>
                        <option value="EUR">€</option>
                    </select>
                </div>
            </div>

            <div id="paymentFields" class="space-y-2">
                <label class="block text-sm font-semibold">Платено:</label>
                <input type="number" id="paidBGN" step="0.01" class="w-full p-3 rounded-xl border" placeholder="Платено в лв">
                <input type="number" id="paidEUR" step="0.01" class="w-full p-3 rounded-xl border" placeholder="Платено в €">
            </div>

            <div id="errorBox" class="hidden p-3 rounded-xl error-box text-red-700 text-sm text-center font-bold">
                Недостатъчна сума!
            </div>

            <div id="resultArea" class="hidden transition-opacity duration-500 mt-6 pt-6 border-t">
                <label class="block text-sm font-semibold mb-2">Ресто в:</label>
                <div class="flex bg-gray-200 rounded-lg p-1 mb-4">
                    <button onclick="updateResult('EUR')" id="btnEUR" class="flex-1 py-2 rounded-md transition-all">€ (EUR)</button>
                    <button onclick="updateResult('BGN')" id="btnBGN" class="flex-1 py-2 rounded-md transition-all">лв (BGN)</button>
                </div>
                <div class="text-center">
                    <div id="mainChange" class="text-3xl font-bold text-gray-900">0.00</div>
                    <div id="secondaryChange" class="text-sm text-gray-500">еквивалент: 0.00</div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-[10px] text-gray-400">
            <p>Курс: 1 EUR = 1.95583 BGN</p>
            <p>© [Невелина Босева]</p>
        </footer>
    </div>

    <script>
        const RATE = 1.95583;
        let selectedResultCurrency = 'EUR';

        // 1. Динамичен фон
        const bgPattern = document.getElementById('bgPattern');
        const symbols = ['€', 'лв'];
        for (let i = 0; i < 40; i++) {
            const span = document.createElement('span');
            span.className = 'bg-symbol flex items-center justify-center';
            span.innerText = symbols[Math.floor(Math.random() * symbols.length)];
            span.style.animationDelay = `${Math.random() * 5}s`;
            bgPattern.appendChild(span);
        }

        // 2. Рисуване на икона с Canvas
        const canvas = document.getElementById('appIcon');
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#228b22';
        ctx.beginPath();
        ctx.roundRect(0, 0, 80, 80, 20);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.font = 'bold 20px Comfortaa';
        ctx.textAlign = 'center';
        ctx.fillText('DualPay', 40, 35);
        ctx.font = '18px Comfortaa';
        ctx.fillText('€ ⇄ лв', 40, 60);

        // 3. Логика на изчисление
        const inputs = ['dueAmount', 'dueCurrency', 'paidBGN', 'paidEUR'];
        inputs.forEach(id => document.getElementById(id).addEventListener('input', calculate));

        function calculate() {
            const due = parseFloat(document.getElementById('dueAmount').value) || 0;
            const dueCurr = document.getElementById('dueCurrency').value;
            const pBGN = parseFloat(document.getElementById('paidBGN').value) || 0;
            const pEUR = parseFloat(document.getElementById('paidEUR').value) || 0;

            const dueInBGN = dueCurr === 'EUR' ? due * RATE : due;
            const totalPaidInBGN = pBGN + (pEUR * RATE);
            const changeInBGN = totalPaidInBGN - dueInBGN;

            const errorBox = document.getElementById('errorBox');
            const resultArea = document.getElementById('resultArea');

            if (totalPaidInBGN < dueInBGN && totalPaidInBGN > 0) {
                errorBox.classList.remove('hidden');
                resultArea.classList.add('hidden');
            } else if (totalPaidInBGN >= dueInBGN && due > 0) {
                errorBox.classList.add('hidden');
                resultArea.classList.remove('hidden');
                window.lastChangeBGN = changeInBGN;
                updateResult(selectedResultCurrency);
            } else {
                errorBox.classList.add('hidden');
                resultArea.classList.add('hidden');
            }
        }

        function updateResult(curr) {
            selectedResultCurrency = curr;
            const changeBGN = window.lastChangeBGN || 0;
            const mainEl = document.getElementById('mainChange');
            const secEl = document.getElementById('secondaryChange');
            
            const btnEUR = document.getElementById('btnEUR');
            const btnBGN = document.getElementById('btnBGN');

            if (curr === 'EUR') {
                mainEl.innerText = (changeBGN / RATE).toFixed(2) + ' €';
                secEl.innerText = `еквивалент: ${changeBGN.toFixed(2)} лв`;
                btnEUR.className = 'flex-1 py-2 rounded-md bg-white shadow-sm font-bold';
                btnBGN.className = 'flex-1 py-2 rounded-md text-gray-500';
            } else {
                mainEl.innerText = changeBGN.toFixed(2) + ' лв';
                secEl.innerText = `еквивалент: ${(changeBGN / RATE).toFixed(2)} €`;
                btnBGN.className = 'flex-1 py-2 rounded-md bg-white shadow-sm font-bold';
                btnEUR.className = 'flex-1 py-2 rounded-md text-gray-500';
            }
        }

        // PWA Service Worker (Inline Blob)
        const swContent = `
            self.addEventListener('install', e => e.waitUntil(caches.open('pwa-v1').then(c => c.addAll(['./']))));
            self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
        `;
        const blob = new Blob([swContent], {type: 'text/javascript'});
        const swUrl = URL.createObjectURL(blob);
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register(swUrl);
        }

        // Manifest Generation
        const manifest = {
            name: 'DualPay Calculator',
            short_name: 'DualPay',
            start_url: '.',
            display: 'standalone',
            background_color: '#f0f7ff',
            theme_color: '#228b22',
            icons: [{ src: 'https://cdn-icons-png.flaticon.com/512/2454/2454282.png', sizes: '512x512', type: 'image/png' }]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestUrl;
        document.head.appendChild(link);
    </script>
</body>
</html>